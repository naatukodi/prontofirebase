<div class="header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 0 16px;">
  <nav class="navigation-links"></nav>
  <div class="user-info" *ngIf="currentUser">
    Welcome, {{ currentUser.name }}
  </div>
</div>

<mat-form-field appearance="fill" style="margin-bottom: 12px;">
  <mat-label>Filter by Created Date</mat-label>
  <mat-date-range-input [rangePicker]="picker">
    <input matStartDate placeholder="Start date" [(ngModel)]="fromDate" (dateChange)="applyFilter()">
    <input matEndDate placeholder="End date" [(ngModel)]="toDate" (dateChange)="applyFilter()">
  </mat-date-range-input>
  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
  <mat-date-range-picker #picker></mat-date-range-picker>
</mat-form-field>

<div class="step-filter">
  <button
    mat-button
    [class.active]="selectedStep === ''"
    (click)="selectedStep=''; applyFilter()">
    All ({{ claims.length }})
  </button>

  <ng-container *ngFor="let s of steps">
    <button
      mat-button
      [class.active]="selectedStep === s"
      [disabled]="(stepCounts[s] || 0) === 0"
      (click)="selectedStep=s; applyFilter()">
      {{ s }} ({{ stepCounts[s] || 0 }})
    </button>
  </ng-container>
</div>

<div *ngIf="loading" class="loading">Loading valuations…</div>
<div *ngIf="!loading && error" class="error">{{ error }}</div>

<ng-container *ngIf="!loading && !error">
  <div *ngIf="filteredClaims.length === 0" class="empty">No valuations to display.</div>

  <table *ngIf="filteredClaims.length > 0"
         mat-table
         [dataSource]="filteredClaims"
         class="dashboard-table">

    <ng-container matColumnDef="vehicleNumber">
      <th mat-header-cell *matHeaderCellDef>VEHICLE NO.</th>
      <td mat-cell *matCellDef="let v">{{ v.vehicleNumber }}</td>
    </ng-container>

    <ng-container matColumnDef="assignedTo">
      <th mat-header-cell *matHeaderCellDef>ASSIGNED TO</th>
      <td mat-cell *matCellDef="let v">{{ v.assignedTo }}</td>
    </ng-container>

    <ng-container matColumnDef="phone">
      <th mat-header-cell *matHeaderCellDef>PHONE</th>
      <td mat-cell *matCellDef="let v">{{ v.assignedToPhoneNumber }}</td>
    </ng-container>

    <ng-container matColumnDef="location">
      <th mat-header-cell *matHeaderCellDef>LOCATION</th>
      <td mat-cell *matCellDef="let v">{{ v.location }}</td>
    </ng-container>

    <ng-container matColumnDef="createdAt">
      <th mat-header-cell *matHeaderCellDef>CREATED</th>
      <td mat-cell *matCellDef="let v">{{ v.createdAt | date:'short' }}</td>
    </ng-container>

    <ng-container matColumnDef="age">
      <th mat-header-cell *matHeaderCellDef>TAT</th>
      <td mat-cell *matCellDef="let v"
          [ngClass]="{
            'age-1': ageInDays(v) === 1,
            'age-2': ageInDays(v) === 2,
            'age-3plus': ageInDays(v) >= 3
          }">
        {{ ageInDays(v) }}
      </td>
    </ng-container>

    <ng-container matColumnDef="redFlag">
      <th mat-header-cell *matHeaderCellDef>FLAG</th>
      <td mat-cell *matCellDef="let v">
        <span [class.red]="v.redFlag">{{ v.redFlag ? '⚑' : '' }}</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="applicant">
      <th mat-header-cell *matHeaderCellDef>APPLICANT</th>
      <td mat-cell *matCellDef="let v">
        {{ v.applicantName }} ({{ v.applicantContact }})
      </td>
    </ng-container>

    <ng-container matColumnDef="info">
      <th mat-header-cell *matHeaderCellDef>VALUATION</th>
      <td mat-cell *matCellDef="let v">
        {{ v.valuationType }} — {{ v.name }}
      </td>
    </ng-container>

    <ng-container matColumnDef="currentStep">
      <th mat-header-cell *matHeaderCellDef>CURRENT STEP</th>
      <td mat-cell *matCellDef="let v">{{ steps[getStepIndex(v)] }}</td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>STATUS</th>
      <td mat-cell *matCellDef="let v">{{ v.status }}</td>
    </ng-container>

    <ng-container matColumnDef="action">
      <th mat-header-cell *matHeaderCellDef>ACTION</th>
      <td mat-cell *matCellDef="let v">
        <button mat-raised-button color="primary" (click)="openCase(v); $event.stopPropagation()">
          ENTER
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let v; columns: displayedColumns;"></tr>

  </table>
</ng-container>